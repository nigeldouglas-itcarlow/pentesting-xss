# Cross Site Scripting (XSS) Penetration Testing
The goal is to fix 11 PHP webpages that could easily be exploited by Cross-Site Scripting (XSS).

| XSS Vulnerability  | Source PHP | Fixed PHP Code | Description of Change |
| ------------- | ------------- | ------------- | ------------- |
| Reflective XSS Over GET  | [Lab01.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/lab01.php)  | [lab01-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/lab01-fixed.php)  | The code first uses htmlspecialchars to escape HTML entities in the user-provided input stored in the "name" parameter, preventing the execution of any HTML or script tags. Then, it echoes the sanitized input, ensuring that any potential XSS payloads are displayed as harmless text rather than being executed as code.  |
| Reflective XSS Over GET  | [Lab02.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab02.php)  | [Lab02-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/Lab02-fixed.php)  | These two lines of code use htmlspecialchars with the ENT_QUOTES flag and specify the character encoding as UTF-8 to escape both single and double quotes in the user-provided input, making it resistant to HTML and attribute-based XSS attacks. Then, it echoes the sanitized input, ensuring that any potential XSS payloads are displayed as harmless text rather than being executed as code.  |
| Reflective XSS Over GET  | [Lab03.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab03.php)  | [lab03-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/lab03-fixed.php)  | Lab3.php is almost identical to Lab2.php in the sense that they only removed the line - <b>$name = $_GET["name"];</b> Same code in Lab2-fixed.php prevented same payload.  |
| Reflective XSS Over GET  | [Lab04.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab04.php)  | [lab04-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/lab04-fixed.php)  | This code first uses strip_tags to remove any HTML tags from the user input, allowing only specified safe tags like < b >, < i >, < u >, and < p > to remain. Then, it applies htmlspecialchars with the ENT_QUOTES flag and UTF-8 encoding to escape special characters, ensuring that even if tags are present, they won't be executed as code.  |
| Reflective XSS Over GET  | [Lab05.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab05.php)  | [lab05-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/lab05-fixed.php)  | Lab4.php blocked 'script' and 'img' tags. Lab5.php is the same except is also blocks 'alert' tags. I bypass that by obfuscating the payload, but the actual code fix for Lab4.php is identical to Lab5.php. Same 3 lines of PHP code prevented the obfuscated XSS payload by first using strip_tags to remove any HTML tags not explicitly allowed before employing htmlspecialchars to escape special characters, rendering the payload harmless.   |
| Reflective XSS Over POST  | [Lab06.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab06.php)  | [lab06-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/lab06-fixed.php)  | As we have done thus far, our PHP sanitization controls use the html special characters function with the ENT_QUOTES flag to convert characters like < and > into their HTML entity equivalents. This encoding prevents the <script>alert("XSS")</script> payload from being interpreted as HTML and executed as JS.  |
| DOM XSS Over HTTP GET  | [Lab07.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab07.php)  | [lab07-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/lab07-fixed.php)  | This attack was a no-PHP (only JS approach). The JS code I used in the fix doesn't inherently prevent the payload I used; instead, it processed the payload as text content and appended it to the HTML body. In future, if an attacker passes #<script>alert("XSS")</script> as the fragment identifier (#) in the URL, the JS code extracts it from the location.hash, creates a new div element, sets its text content to the extracted value (#<script>alert("XSS")</script>), and appends this content as a child of the body element. This results in the payload being displayed as text on the webpage rather than executing it as a script.  |
| Reflective XSS Over POST  | [Lab08.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab08.php)  | [lab08-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/lab08-fixed.php)  | This was another HTTP POST scenario in the form being sent to the server via $_POST["TX_name"]. In my fixed code, I immediately applied html special characters to ($_POST["TX_name"], ENT_QUOTES, 'UTF-8') of the input value to prevent this type of XSS.  |
| Reflective XSS Over GET  | [Lab09.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab09.php)  | [lab09-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/lab09-fixed.php)  | I successfully crafted this XSS payload - ?number=10); alert('XSS'); The payload was passed as a parameter called "number" in the URL's query string when making an HTTP GET request to the PHP webpage. To prevent this, I checked if the "number" parameter was empty. If it was empty, the page displays a message instructing the user to pass a payload to the "number" parameter. If the "number" parameter was not empty, the page attempts to validate it as a number using is_numeric($number). In the case of my payload, it was not a valid number, so the validation failed. Because the validation failed, the code didn't proceed to the part where I applied htmlspecialchars to sanitize the input. Therefore, the payload remained unchanged and was not executed as JS. |
| Reflective XSS Over POST  | [Lab10.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab10.php)  | [lab10-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/lab10-fixed.php)  | In the original 10.php code, it attempted to remove the string "alert" from the user input using preg_replace. However, this approach is insufficient for a few clear reasons. It was ineffective at String Removal since the RegEx statement /alert/ only matches the exact string "alert." An attackers could easily evade this filter by using variations, such as "alert," "al<e>rt," or other obfuscation techniques, as seen in my payload - <s``ript>. It also provided incomplete sanitization since the code only targets the "alert" string. XSS payloads can include various other JavaScript functions, event handlers, and HTML attributes that might not include the word "alert." And finally the code does not perform proper HTML encoding to neutralize special characters. To fix the code, I used the same robust encoding functions like htmlspecialchars to ensure that user-generated content is safely displayed on the page. |
| Reflective XSS Over GET  | [Lab11.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/original-src-files/Lab11.php) | [lab11-fixed.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/Lab11-fixed.php)  | The payload from Lab10 worked on Lab11. Realized that echo $_GET["name"]; was actually blocking the RemoveXSS function on GET "name". As a result, in the fixed version in commented out the echo on GET name, but this enforced the RemoveXSS function in [FilterHeader.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/FilterHeader.php). I used ChatGPT to find tags and functions not listed in the sanitization controls. Settled for <div> tag and it worked. Obfuscated the <style> tags. CSS stuff failed but the webpage was broken as a result of the identified vulnerability. Was easily able to mitigate this by removing <div> tag from being used in future payloads - $val = preg_replace('/<div/i', '', $val);. This fix can be seen in the modified [FilterHeader2.php](https://github.com/nigeldouglas-itcarlow/pentesting-xss/blob/main/FilterHeader2.php) |

## Successfully Tested Payloads

Lab01.php
```
?name=<script>alert(123)</script>
```

Using CSS <style> tags
```
http://localhost/lab/lab01.php?name=<div style='color:red; background-color:green; text-align:center; margin-left:30%; font-weight:bold; font-family: Arial, Helvetica, sans-serif; width:300px; height:300px; display: flex; justify-content: center; align-items: center;'><span style="font-size: 24px;">Cork City FC</span></div>
```

Using HTML5's animated <canvas> tag
```
http://localhost/lab/lab01.php?name=%3Ccanvas id='myCanvas' width='400' height='100'%3E%3C/script%3E%3Cscript%3Evar canvas = document.getElementById('myCanvas');var ctx = canvas.getContext('2d');ctx.font = '30px Arial';var text = 'XSS Vulnerability';var x = 50;var drawText = true;function draw() {  ctx.clearRect(0, 0, canvas.width, canvas.height);  if (drawText) {    ctx.fillStyle = 'red';    ctx.fillText(text, x, 50);  }  x += 1;  if (x > canvas.width) {    x = -ctx.measureText(text).width;  }  drawText = !drawText;}setInterval(draw, 500);%3C/script%3E
```

Lab02.php
```
?name=<img%20src=x%20onerror=alert("XSS")>
```

Lab03.php (Same as Lab2.php)
```
?name=<img%20src=x%20onerror=alert("XSS")
```

Lab04.php
```
?name="><svg%20onload=alert("XSS")>
```

Lab05.php
```
?name=%22%3E%3Csvg/onload=eval(String.fromCharCode(97,108,101,114,116,40,39,88,83,83,39,41))>
```

Lab06.php
```
<script>alert("XSS")</script>
```

Lab07.php
```
#<script>alert("XSS")</script>
```

Lab08.php
```
?TX_name=Nigel"><script>alert("XSS")</script>
```

Lab09.php
```
?number=10); alert('XSS');//
```

Lab10.php
```
Nigel"><s``ript>ale``rt``('Nigelâ€™s Cross Site Scripting')</scri``pt>
```

Lab11.php (Pre-obfuscated)
```
http://localhost/lab/lab11-fixed.php?name=<div style='color:red; width:50px; height:50px;'>XSS Payload</div>
```

Lab11.php (Post-obfuscation)
```
http://localhost/lab/lab11-fixed.php?name=<div%20s&#x74;y&#x6c;&#x65;=&#x72;ed;color&#x3a;green;width&#x3a;5000px;height&#x3a;50000px;>XSS%20Payload</div>
```

Lab11.php - using the 'video' tags:
```
http://localhost/lab/lab11-fixed.php?name=<video width="50%" height="50%" controls>
  <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WhatCarCanYouGetForAGrand.mp4" type="video/mp4">
  XSS Vulnerability Identified by Nigel Douglas.
</video>
```

## Comparing my findings using Zap Proxy

I had to compare the manual findings with those identified in my OWASP Zap report. <br/>
However, I'm still unsure how to use the findings of this tool to mitigate XSS attacks:

![zap-report1](https://github.com/nigeldouglas-itcarlow/pentesting-xss/assets/126002808/5555a3f7-dc59-46f4-9ce1-4c17005281d4)

## Used ChatGPT to identify gaps
The sanitization efforts had large arrays of keywords and tags that are blocked.
I was able to identify <svg> and the "typeof" attribut that were not listed in the PHP controls:

![fields not listed](https://github.com/nigeldouglas-itcarlow/pentesting-xss/assets/126002808/29ba2547-2739-4cb4-afe7-c6dd629f7202)


